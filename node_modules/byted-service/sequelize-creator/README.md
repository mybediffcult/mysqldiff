# SequelizeCreator

`SequelizeCreator` 基于 [Sequelize](http://docs.sequelizejs.com/manual/)，提供了根据PSM寻址的能力以及自动导入Model定义文件的能力。

## 1. 创建SequelizeCreator实例
```javascript
const { SequelizeCreator } = require('byted-service');

const options = {
    consul: {
        host: '127.0.0.1',
        port: 2280
    }
};
const sequelizeCreator = new SequelizeCreator(options);
```

`options`
- `consul`: Consul Agent配置，默认值为`{host: '127.0.0.1', port: 2280}`。

## 2. 创建Sequelize实例
`SequelizeCreator` 提供了 `create` 方法用于创建 `Sequelize` 实例。`create` 对 `Sequelize` 实例创建参数进行了扩展，支持通过 `psm` 选项指定数据库地址，而且可通过 `modelDir` 选项指定模型定义目录，创建实例时会自动从该目录导入模型定义。

```javascript
// 根据PSM寻址（单机）
const sequelize = await sequelizeCreator.create({
    name: 'gecko_dev',
    username: '',
    password: '',
    modelDir: path.resolve(__dirname, 'model'), // 模型定义目录
    options: {
        psm: 'toutiao.mysql.gecko_dev_read',        
    },
});

// 根据PSM寻址（主从）
const sequelize = await sequelizeCreator.create({
    name: 'gecko_dev',
    username: '',
    password: '',
    modelDir: path.resolve(__dirname, 'model'), // 模型定义目录
    options: {
        replication: {
            read: [{
                psm: 'toutiao.mysql.gecko_dev_read',
                username: '',
                password: ''
            }],
            write: {
                psm: 'toutiao.mysql.gecko_dev_write',
                username: '',
                password: ''
            }
        },
    },
});

// 直接指定IP地址和端口（单机）
const sequelize = await sequelizeCreator.create({
    name: 'gecko_dev',
    username: '',
    password: '',
    modelDir: path.resolve(__dirname, 'model'), // 模型定义目录
    options: {
        host: '127.0.0.1',
        port: 3306
    },
});

// 直接指定IP地址和端口（主从）
const sequelize = await sequelizeCreator.create({
    name: 'gecko_dev',
    username: '',
    password: '',
    modelDir: path.resolve(__dirname, 'model'), // 模型定义目录
    options: {
        replication: {
            read: [{
                host: '127.0.0.1',
                port: 3306,
                username: '',
                password: ''
            }],
            write: {
                host: '127.0.0.1',
                port: 3306,
                username: '',
                password: ''
            }
        },
    },
});
```

## 3. 模型定义
在通过 `SequelizeCreator` 创建 `Sequelize` 实例时，如果指定了模型定义目录 `modelDir`，会自动从该目录导入模型定义文件。模型定义文件如下：

```javascript
// model/user.js

module.exports = (sequelize, DataTypes) => {
    // 表定义
    const User = sequelize.define('user', {
        id: {
            type: DataTypes.INTEGER,
            primaryKey: true,
            autoIncrement: true
        },
        ssoid: {
            type: DataTypes.INTEGER,
            unique: true
        },
        username: {
            type: DataTypes.STRING
        },
        email: {
            type: DataTypes.STRING
        },
        createdAt: {
            type: DataTypes.TIME,
            field: 'created_at'
        },
        updatedAt: {
            type: DataTypes.TIME,
            field: 'updated_at'
        },
    });

    // 关联关系定义
    User.associate = function (sequelize) {
        const App = sequelize.App;
        this.hasMany(App, { foreignKey: 'uid', sourceKey: 'id' });
    }

    return User;
}
```

## 4. 操作数据库
请参考 `Sequelize` 使用文档：[http://docs.sequelizejs.com/](http://docs.sequelizejs.com/)。