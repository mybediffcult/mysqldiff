# Consul

## 服务地址查询
### 1. 创建Consul实例
```javascript
const { Consul } = require('byted-service');

const options = {
    host: '127.0.0.1',
    port: 2280
};
const consul = new Consul(options);
```

`options`
- `host`: Consul Agent地址，默认为127.0.0.1，如在本地测试可填开发机地址
- `port`: Consul Agent端口，默认为2280

### 2. 根据服务PSM查询服务地址
```javascript
// 获取所有查询结果
const lookupAddresses = await consul.lookup('toutiao.tos.tosapi', {
    env: 'prod',
    cluster: 'default'
});
console.log('lookup: ', lookupAddresses);

// 获取第一条查询结果
const firstAddress = await consul.first('toutiao.tos.tosapi', {
    env: 'prod',
    cluster: 'default' 
});
console.log('first address: ', firstAddress);

// 随机获取一条查询结果
const randomAddress = await consul.random('toutiao.tos.tosapi', {
    env: 'prod',
    cluster: 'default' 
});
console.log('random address: ', randomAddress);
```

查询时可以指定查询选项`options`，查询方法会根据查询选项来过滤查询结果。`options`支持的值如下：
- `env`：环境变量，默认为`prod`，如果想获取所有环境的地址，则设为 `*`;
- `cluster`：集群名称，默认为`default`，如果想获取所有集群的地址，则设为 `*`。


## 服务地址变化监听
`Consul` 模块下挂载了一个 `ServiceWatcher` 类，通过该类可监听服务地址的变化。`ServiceWatcher`类会定时轮询Consul Agent，并将得到的结果与上一次的结果进行比较，如果地址列表发生了变化，则通过事件通知调用方。


```javascript
const { Consul } = require('byted-service');
const { ServiceWatcher } = Consul;

// 创建ServiceWatcher实例，用于监听服务地址变化（watcher方法支持链式调用）
const watcher = new ServiceWatcher({
    interval: 5000, // 轮询时间间隔，单位ms，默认5000
    consul: { //  Consul配置选项
        host: '10.3.23.41',
        port: 2280 
    }
});

// 添加Service
watcher.addService('toutiao.tos.tosapi', { env: 'prod', cluster: 'default' });
watcher.addService('toutiao.redis.ies_fe_gecko', { env: 'prod', cluster: 'default' });

// 启动监听
watcher.watch();

// 注册地址变化事件回调
watcher.on('update', (service, addresses) => {
    console.log(service, addresses);
});
```