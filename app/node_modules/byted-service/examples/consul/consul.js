const { Consul } = require('../../index');
const { ServiceWatcher } = Consul;

async function main() {
    // 创建Consul实例
    const consul = new Consul({
        host: '10.3.23.41',
        port: 2280
    });

    // 获取所有查询结果
    const lookupAddresses = await consul.lookup('toutiao.tos.tosapi', {
        env: 'prod',
        cluster: 'default'
    });
    console.log('lookup: ', lookupAddresses);
    
    // 获取第一条查询结果
    const firstAddress = await consul.first('toutiao.tos.tosapi', {
        env: 'prod',
        cluster: 'default' 
    });
    console.log('first address: ', firstAddress);

    // 随机获取一条查询结果
    const randomAddress = await consul.random('toutiao.tos.tosapi', {
        env: 'prod',
        cluster: 'default' 
    });
    console.log('random address: ', randomAddress);

    // 创建ServiceWatcher实例，用于监听服务地址变化（watcher方法支持链式调用）
    const watcher = new ServiceWatcher({
        interval: 5000,
        consul: {
            host: '10.3.23.41',
            port: 2280 
        }
    });

    // 添加Service
    watcher.addService('toutiao.tos.tosapi', { env: 'prod', cluster: 'default' });
    watcher.addService('toutiao.redis.ies_fe_gecko', { env: 'prod', cluster: 'default' });

    // 启动监听
    watcher.watch();

    // 注册地址变化事件回调
    watcher.on('update', (service, addresses) => {
        console.log(service, addresses);
    });
}

main();