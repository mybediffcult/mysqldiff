const path = require('path');
const { SequelizeCreator } = require('../../index');

async function main() {
    // 创建SequelizeCreator实例，如果需要通过PSM寻址，则传入Consul Agent配置
    const sequelizeCreator = new SequelizeCreator({
        consul: {
            host: '10.3.23.41',
            port: 2280
        }
    });

    // 使用CLS
    sequelizeCreator.useCLS('default');

    // 创建Sequelize实例，对Sequelize的实例化配置进行了扩展，支持通过PSM寻址
    const config = {
        name: 'gecko_dev',
        username: '',
        password: '',
        modelDir: path.resolve(__dirname, 'model'), // 模型定义目录
        options: {
            replication: {
                read: [{
                    psm: 'toutiao.mysql.gecko_dev_read',
                    username: 'gecko_dev_r',
                    password: 'Y47N1FcA0vu1H6j_Qlpk3HccB9x5xpTG'
                }],
                write: {
                    psm: 'toutiao.mysql.gecko_dev_write',
                    username: 'gecko_dev_w',
                    password: 'iwgWOnXBbXE3wuM_eCBGBP6MYC482aUh'
                }
            },
        }
    };
    const sequelize = await sequelizeCreator.create(config);
    
    // 操作MySQL数据库
    const user = await sequelize.User.findOne({
        where: { username: 'yeyuanfeng' }
    });
    console.log('username: ', user.username);
    console.log('email: ', user.email);

    const apps = await user.getApps();
    apps.forEach(app => {
        console.log('app name: ', app.name);
        console.log('app thumb: ', app.thumb);
    });

    // 断开连接
    sequelize.close();
}

main();